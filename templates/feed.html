{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h1 class="page-title">{{ title }}</h1>

<div class="post-list">
    {% if not posts %}
        <div class="text-center p-5">
            <p class="fs-4 text-muted">Your feed is quiet! Try following some users or check the Top Smiles page.</p>
            <a href="{{ url_for('top') }}" class="btn btn-primary">Go to Top Smiles</a>
        </div>
    {% endif %}

    {% for post in posts %}
    <div class="post-card">
        <div class="post-body">
            
            <a href="{{ url_for('view_single_post', post_id=post.id) }}" class="text-decoration-none">

                {% if post.content %}
                    <p class="post-content-text">{{ post.content }}</p>
                {% endif %}
            
                {% if post.link %}
                    <p>
                        <a href="{{ post.link }}" target="_blank" class="story-link">
                            ðŸ”— View External Story
                        </a>
                    </p>
                {% endif %}

            </a> 
            
            {% if post.image %}
                <img src="{{ post.image }}" class="post-image" alt="Post image">
            {% endif %}

            <div class="d-flex justify-content-between align-items-center mt-3">

    <div class="d-flex align-items-center">
        {% set allowed_emojis = ["ðŸ˜Š", "ðŸ˜‚", "ðŸ¥¹"] %}

        {% for emoji in allowed_emojis %}
        <form action="{{ url_for('smile', post_id=post.id) }}" method="POST" style="display:inline-block; margin-right: 5px;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="reaction" value="{{ emoji }}"/>

            <button type="submit"
                    class="btn btn-sm btn-smile
                           {% if post.user_reaction == emoji %}btn-smile-active{% endif %}"
                    title="React with {{ emoji }}">
                {{ emoji }}
            </button>
        </form>
        {% endfor %}

        <span class="post-meta ms-2">
            {% if post.top_reactions %}
                {% for reaction_pair in post.top_reactions.split(',') %}
                    {% set parts = reaction_pair.split(':') %}
                    <span title="{{ parts[1] }} total reactions with {{ parts[0] }}">
                        {{ parts[0] }} {{ parts[1] }}
                    </span>
                {% endfor %}
            {% else %}
                Total Smiles: {{ post.smiles }}
            {% endif %}
        </span>
    </div>

    <div class="post-meta">
        Posted by
        <a href="{{ url_for('user_profile', username=post.username) }}">@{{ post.username }}</a>
        â€” {{ post.timestamp }}
    </div>

</div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}